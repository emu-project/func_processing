
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>resources.afni package &#8212; func_processing  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="resources.ashs package" href="resources.ashs.html" />
    <link rel="prev" title="resources package" href="resources.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="resources-afni-package">
<h1>resources.afni package<a class="headerlink" href="#resources-afni-package" title="Permalink to this headline">¶</a></h1>
<div class="section" id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="module-resources.afni.copy">
<span id="resources-afni-copy-module"></span><h2>resources.afni.copy module<a class="headerlink" href="#module-resources.afni.copy" title="Permalink to this headline">¶</a></h2>
<p>Copy data from fMRIprep to AFNI.</p>
<p>Copy certain derivative output from fMRIprep to AFNI for use in
finishing pre-processing, deconvolution, and group-level analyses.</p>
<dl class="py function">
<dt id="resources.afni.copy.copy_data">
<code class="sig-prename descclassname">resources.afni.copy.</code><code class="sig-name descname">copy_data</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">prep_dir</span></em>, <em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">subj</span></em>, <em class="sig-param"><span class="n">task</span></em>, <em class="sig-param"><span class="n">tplflow_str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.copy.copy_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Get relevant fMRIprep files, rename.</p>
<p>Copies select fMRIprep files into AFNI derivatives, prepares
for AFNI pre-processing steps.</p>
<dl class="simple">
<dt>prep_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/fmriprep</p>
</dd>
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>subj<span class="classifier">str</span></dt><dd><p>BIDS subject string (sub-1234)</p>
</dd>
<dt>task<span class="classifier">str</span></dt><dd><p>BIDS task string (task-test)</p>
</dd>
<dt>tplflow_str<span class="classifier">str</span></dt><dd><p>template ID string, for finding fMRIprep output in
template space (space-MNIPediatricAsym_cohort-5_res-2)</p>
</dd>
</dl>
<dl>
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>files copied from derivatives/fMRIprep to derivatives/afni
e.g. {</p>
<blockquote>
<div><p>“mask-brain”: “/path/to/anat/&lt;BIDS-str&gt;_desc-brain_mask.nii.gz”,
“struct-t1”: “/path/to/anat/&lt;BIDS-str&gt;_desc-preproc_T1w.nii.gz”,
}</p>
</div></blockquote>
</dd>
</dl>
<dl class="simple">
<dt>afni_data keys:</dt><dd><p>struct-t1 = T1w structural
mask-brain = brain mask
mask-probGM = probability gray matter mask
mask-probWM = probability white matter mask
mask-probCSF = probability csf mask
epi-preproc? = fMRIprep preprocessed EPI for run-?
mot-confound? = confounds (motion) file for EPI data for run-?</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-resources.afni.deconvolve">
<span id="resources-afni-deconvolve-module"></span><h2>resources.afni.deconvolve module<a class="headerlink" href="#module-resources.afni.deconvolve" title="Permalink to this headline">¶</a></h2>
<p>Write and run deconvolution commands.</p>
<p>Use AFNI’s 3dDeconvolve and 3dREMLfit to deconvolve
pre-processed EPI data.</p>
<div class="section" id="notes">
<h3>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h3>
<p>Requires “submit” module at same level.</p>
<dl class="py function">
<dt id="resources.afni.deconvolve.regress_resting">
<code class="sig-prename descclassname">resources.afni.deconvolve.</code><code class="sig-name descname">regress_resting</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">proj_meth</span><span class="o">=</span><span class="default_value">'anaticor'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.deconvolve.regress_resting" title="Permalink to this definition">¶</a></dt>
<dd><p>Construct regression matrix for resting state data.</p>
<p>Conduct a principal components analysis to identify
CSF timeseries. Use CSF timeseries as nuissance regressor,
along with motion etc to clean signal via deconvolution.
Residuals (cleaned signal) are then used to project regression
matrices. Anaticor uses WM as a nuissance regressor.</p>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>epi-scale1 = single/first scaled file
mask-min = mask of voxels with &gt;min signal
mask-erodedCSF = eroded CSF mask
mot-mean = mean motion timeseries
mot-deriv = derivative motion timeseries
mot-censor = binary censor vector</p>
</dd>
</dl>
</dd>
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/project_dir/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>proj_meth<span class="classifier">str</span></dt><dd><p>[anaticor | original] method of matrix progression.</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated fields
reg-matrix = regression matrix</p>
</dd>
</dl>
<p>Only supports RS conducted in single run</p>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.deconvolve.run_reml">
<code class="sig-prename descclassname">resources.afni.deconvolve.</code><code class="sig-name descname">run_reml</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">afni_data</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.deconvolve.run_reml" title="Permalink to this definition">¶</a></dt>
<dd><p>Deconvolve EPI timeseries.</p>
<p>Generate an idea of nuissance signal from the white matter and
include this in the generated 3dREMLfit command.</p>
<dl class="simple">
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/project_dir/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>epi-scale[1..N] = list of scaled files
mask-erodedWM = eroded WM mask</p>
</dd>
</dl>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated for nuissance, deconvolved files
epi-nuiss = nuissance signal file
rml-&lt;decon_name&gt; = deconvolved file (&lt;decon_name&gt;_stats_REML+tlrc)</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.deconvolve.timing_files">
<code class="sig-prename descclassname">resources.afni.deconvolve.</code><code class="sig-name descname">timing_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">dset_dir</span></em>, <em class="sig-param"><span class="n">deriv_dir</span></em>, <em class="sig-param"><span class="n">subj</span></em>, <em class="sig-param"><span class="n">sess</span></em>, <em class="sig-param"><span class="n">task</span></em>, <em class="sig-param"><span class="n">decon_name</span><span class="o">=</span><span class="default_value">'UniqueBehs'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.deconvolve.timing_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate AFNI timing files.</p>
<p>Written specifically for the EMU study. Use dset/func/events.tsv
files to generate AFNI-style timing files for each unique
behavior (trial_type).</p>
<dl class="simple">
<dt>dset_dir<span class="classifier">str</span></dt><dd><p>/path/to/BIDS/dset</p>
</dd>
<dt>deriv_dir<span class="classifier">str</span></dt><dd><p>/path/to/BIDS/derivatives/afni</p>
</dd>
<dt>subj<span class="classifier">str</span></dt><dd><p>BIDS subject string (sub-1234)</p>
</dd>
<dt>sess<span class="classifier">str</span></dt><dd><p>BIDS session string (ses-A)</p>
</dd>
<dt>task<span class="classifier">str</span></dt><dd><p>BIDS task string (task-test)</p>
</dd>
<dt>decon_name<span class="classifier">str</span></dt><dd><p>name of deconvolution given all unique behaviors [default=UniqueBehs]</p>
</dd>
</dl>
<dl>
<dt>decon_plan<span class="classifier">dict</span></dt><dd><p>Matches behaviors to timing file
{&lt;decon_name&gt;: {</p>
<blockquote>
<div><p>beh-A: /path/to/<a href="#id1"><span class="problematic" id="id2">*</span></a>_desc-behA_events.1D,
beh-B: /path/to/<a href="#id3"><span class="problematic" id="id4">*</span></a>_desc-behB_events.1D,
}</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>Currently only writes onset time, not married duration.
Behavior key (beh-A, beh-B above) become label of deconvolved sub-brick.</p>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.deconvolve.write_decon">
<code class="sig-prename descclassname">resources.afni.deconvolve.</code><code class="sig-name descname">write_decon</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">decon_name</span></em>, <em class="sig-param"><span class="n">tf_dict</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">dur</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.deconvolve.write_decon" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate deconvolution script.</p>
<p>Write a deconvolution script using the pre-processed data, motion, and
censored files passed by afni_data. Uses a 2GAM basis function
(AFNI’s TWOGAMpw). This script is used to generate X.files and the
foo_stats.REML_cmd.</p>
<p>Timing files should contain AFNI-formatted onset times (duration is hardcoded),
using the asterisk for runs in which a certain behavior does not occur.</p>
<dl class="simple">
<dt>decon_name: str</dt><dd><p>name of deconvolution, useful when conducting multiple
deconvolutions on same session. Will be appended to
BIDS task name (decon_&lt;task-name&gt;_&lt;decon_name&gt;).</p>
</dd>
<dt>tf_dict<span class="classifier">dict</span></dt><dd><p>timing files dictionary, behavior string is key
e.g. {“lureFA”: “/path/to/tf_task-test_lureFA.txt”}</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>epi-scale[1..N] = list of scaled files
mot-mean = mean motion timeseries
mot-deriv = derivative motion timeseries
mot-censor = binary censory vector</p>
</dd>
</dl>
</dd>
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/project_dir/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>dur<span class="classifier">int/float/str</span></dt><dd><p>duration of event to model</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated with REML commands
dcn-&lt;decon_name&gt; = name of decon reml command</p>
</dd>
</dl>
<dl>
<dt>Deconvolution files will be written in AFNI format, rather</dt><dd><p>than BIDS. This includes the X.files (cue spooky theme), script,
and deconvolved output. Files names will have the format:</p>
<blockquote>
<div><p>decon_&lt;bids-task&gt;_&lt;decon_name&gt;</p>
</div></blockquote>
</dd>
</dl>
</dd></dl>

</div>
</div>
<div class="section" id="module-resources.afni.group">
<span id="resources-afni-group-module"></span><h2>resources.afni.group module<a class="headerlink" href="#module-resources.afni.group" title="Permalink to this headline">¶</a></h2>
<p>Functions for group-level analyses.</p>
<p>Makes group masks, conducts group statistics.</p>
<dl class="py function">
<dt id="resources.afni.group.int_mask">
<code class="sig-prename descclassname">resources.afni.group.</code><code class="sig-name descname">int_mask</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">task</span></em>, <em class="sig-param"><span class="n">deriv_dir</span></em>, <em class="sig-param"><span class="n">group_data</span></em>, <em class="sig-param"><span class="n">group_dir</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.group.int_mask" title="Permalink to this definition">¶</a></dt>
<dd><p>Create group gray matter intersection mask.</p>
<p>For a specific task.</p>
<dl class="simple">
<dt>task<span class="classifier">str</span></dt><dd><p>BIDS task string (task-rest)</p>
</dd>
<dt>deriv_dir<span class="classifier">str</span></dt><dd><p>location of project AFNI derivatives</p>
</dd>
<dt>group_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>mask-gm = gray matter mask
subj-list = list of subjects</p>
</dd>
</dl>
</dd>
<dt>group_dir<span class="classifier">str</span></dt><dd><p>output location of work</p>
</dd>
</dl>
<dl class="simple">
<dt>group_data<span class="classifier">dict</span></dt><dd><p>updated with the field
mask-int = GM intersect mask</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.group.resting_etac">
<code class="sig-prename descclassname">resources.afni.group.</code><code class="sig-name descname">resting_etac</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">seed</span></em>, <em class="sig-param"><span class="n">group_data</span></em>, <em class="sig-param"><span class="n">group_dir</span></em>, <em class="sig-param"><span class="n">do_blur</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.group.resting_etac" title="Permalink to this definition">¶</a></dt>
<dd><p>Conduct A vs not-A via ETAC.</p>
<dl class="simple">
<dt>seed<span class="classifier">str</span></dt><dd><p>seed name (rPCC)</p>
</dd>
<dt>group_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>all-ztrans = list of Ztrans files
mask-int = group GM intersection mask</p>
</dd>
</dl>
</dd>
<dt>group_dir<span class="classifier">str</span></dt><dd><p>location of output directory</p>
</dd>
<dt>do_blur<span class="classifier">bool</span></dt><dd><p>[T/F] whether blur was done in pre-processing</p>
</dd>
</dl>
<dl class="simple">
<dt>group_data<span class="classifier">dict</span></dt><dd><p>updated with the field
S&lt;seed&gt;-etac = final ETAC output file</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.group.task_etac">
<code class="sig-prename descclassname">resources.afni.group.</code><code class="sig-name descname">task_etac</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">beh_list</span></em>, <em class="sig-param"><span class="n">deriv_dir</span></em>, <em class="sig-param"><span class="n">sess</span></em>, <em class="sig-param"><span class="n">group_data</span></em>, <em class="sig-param"><span class="n">group_dir</span></em>, <em class="sig-param"><span class="n">do_blur</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.group.task_etac" title="Permalink to this definition">¶</a></dt>
<dd><p>Conduct A vs B via ETAC.</p>
<dl class="simple">
<dt>beh_list<span class="classifier">list</span></dt><dd><p>two behaviors for setA, setB</p>
</dd>
<dt>deriv_dir<span class="classifier">str</span></dt><dd><p>path to project afni derivatives</p>
</dd>
<dt>sess<span class="classifier">str</span></dt><dd><p>BIDS session (ses-S2)</p>
</dd>
<dt>group_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>subj-list = list of subjects
mask-int = group GM intersection mask
dcn-file = decon file string</p>
</dd>
</dl>
</dd>
<dt>do_blur<span class="classifier">bool</span></dt><dd><p>[T/F] whether blur was done in pre-processing</p>
</dd>
</dl>
<dl class="simple">
<dt>group_data<span class="classifier">dict</span></dt><dd><p>updated with the field
behAB-etac = final output ETAC file</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-resources.afni.masks">
<span id="resources-afni-masks-module"></span><h2>resources.afni.masks module<a class="headerlink" href="#module-resources.afni.masks" title="Permalink to this headline">¶</a></h2>
<p>Functions for making various masks.</p>
<div class="section" id="id5">
<h3>Notes<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Requires “submit” module at same level.</p>
<dl class="py function">
<dt id="resources.afni.masks.make_intersect_mask">
<code class="sig-prename descclassname">resources.afni.masks.</code><code class="sig-name descname">make_intersect_mask</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">subj_num</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">sess</span></em>, <em class="sig-param"><span class="n">task</span></em>, <em class="sig-param"><span class="n">do_blur</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.masks.make_intersect_mask" title="Permalink to this definition">¶</a></dt>
<dd><p>Make EPI-struct intersection mask.</p>
<dl>
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>subj_num<span class="classifier">int/str</span></dt><dd><blockquote>
<div><p>subject identifier, for sbatch job name</p>
</div></blockquote>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>mask-brain = anatomic brain mask</p>
</dd>
<dt>conditionally required keys</dt><dd><p>do_blur = T : epi-blur[1..N] = list of blurred EPI files
do_blur = F : epi-preproc[1..N] = list of fmriprep preprocessed files</p>
</dd>
</dl>
</dd>
</dl>
</dd>
<dt>sess<span class="classifier">str</span></dt><dd><p>BIDS session string (ses-S1)</p>
</dd>
<dt>task<span class="classifier">str</span></dt><dd><p>BIDS task string (task-study)</p>
</dd>
<dt>do_blur<span class="classifier">bool</span></dt><dd><p>[T/F] whether to blur as part of pre-processing</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>mask-int = subject epi-anat intersection mask</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.masks.make_minimum_masks">
<code class="sig-prename descclassname">resources.afni.masks.</code><code class="sig-name descname">make_minimum_masks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">subj_num</span></em>, <em class="sig-param"><span class="n">sess</span></em>, <em class="sig-param"><span class="n">task</span></em>, <em class="sig-param"><span class="n">afni_data</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.masks.make_minimum_masks" title="Permalink to this definition">¶</a></dt>
<dd><p>Make a mask of where minimum signal exists in EPI space.</p>
<p>Used to help with the scaling step, so low values do not
bias the scale. Based off “3dTstat -min”.</p>
<dl class="simple">
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>subj_num<span class="classifier">int/str</span></dt><dd><p>subject identifier, for sbatch job name</p>
</dd>
<dt>sess<span class="classifier">str</span></dt><dd><p>BIDS session string (ses-A)</p>
</dd>
<dt>task<span class="classifier">str</span></dt><dd><p>BIDS task string (task-test)</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>epi-preproc[1..N] = fmriprep pre-processed files
mask-brain = anatomic brain mask</p>
</dd>
</dl>
</dd>
</dl>
<dl class="simple">
<dt>afni_dict<span class="classifier">dict</span></dt><dd><p>updated fields
mask-min = mask of minimum value for task</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.masks.make_tissue_masks">
<code class="sig-prename descclassname">resources.afni.masks.</code><code class="sig-name descname">make_tissue_masks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">subj_num</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">thresh</span><span class="o">=</span><span class="default_value">0.5</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.masks.make_tissue_masks" title="Permalink to this definition">¶</a></dt>
<dd><p>Make tissue class masks.</p>
<dl class="simple">
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>subj_num<span class="classifier">int/str</span></dt><dd><p>subject identifier, for sbatch job name</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>mask-prob[GM|CSF|WM] = tissue probability masks
mask-brain = anatomic brain mask</p>
</dd>
</dl>
</dd>
<dt>thresh<span class="classifier">float [default=0.5]</span></dt><dd><p>value for thresholding probseg files</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated fields
mask-eroded[GM|WM|CSF] = eroded gray, white matter, CSF masks</p>
</dd>
</dl>
</dd></dl>

</div>
</div>
<div class="section" id="module-resources.afni.motion">
<span id="resources-afni-motion-module"></span><h2>resources.afni.motion module<a class="headerlink" href="#module-resources.afni.motion" title="Permalink to this headline">¶</a></h2>
<p>Make motion, censor files for deconvolution.</p>
<p>Use fMRIprep desc-confounds_timeseries.tsv to make
mean motion, derivative motion, and censor files.
Censor includes volume preceding motion event.</p>
<dl class="py function">
<dt id="resources.afni.motion.mot_files">
<code class="sig-prename descclassname">resources.afni.motion.</code><code class="sig-name descname">mot_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">task</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.motion.mot_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Constuct motion and censor files</p>
<p>Mine &lt;fMRIprep&gt;_desc-confounds_timeseries.tsv for motion events, make
motion files for mean (6df) and derivative (6df) motion events. Also,
create motion censor file. Volume preceding a motion event is also
censored. Finally, report the number of censored volumes.</p>
<p>I’m not sure if motion is demeaned or not, given that
it is output by fMRIprep (mined from confounds.tsv file).</p>
<dl class="simple">
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/project_dir/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>mot-confound[1..N] = fmriprep motion confound timeseries</p>
</dd>
</dl>
</dd>
<dt>task<span class="classifier">str</span></dt><dd><p>BIDS task string (task-test)</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated with names of motion files
mot-mean = motion mean file
mot-deriv = motion derivative file
mot-censor = binary censory vector</p>
</dd>
</dl>
<p>As runs do not have an equal number of volumes, motion/censor files
for each run are concatenated into a single file rather than managing
zero padding.</p>
<p>Writes 1D files - AFNI reads tsv as containing a header!</p>
</dd></dl>

</div>
<div class="section" id="module-resources.afni.process">
<span id="resources-afni-process-module"></span><h2>resources.afni.process module<a class="headerlink" href="#module-resources.afni.process" title="Permalink to this headline">¶</a></h2>
<p>Functions for processing EPI data.</p>
<p>Finish pre-processing on fMRIprep output
using an AFNI workflow.</p>
<div class="section" id="id6">
<h3>Notes<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>Requires “submit” module at same level.</p>
<dl class="py function">
<dt id="resources.afni.process.blur_epi">
<code class="sig-prename descclassname">resources.afni.process.</code><code class="sig-name descname">blur_epi</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">subj_num</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">blur_mult</span><span class="o">=</span><span class="default_value">1.5</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.process.blur_epi" title="Permalink to this definition">¶</a></dt>
<dd><p>Blur EPI data.</p>
<p>Blur pre-processed EPI runs with AFNI’s 3dmerge.</p>
<dl class="simple">
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>subj_num<span class="classifier">int/str</span></dt><dd><p>subject identifier, for sbatch job name</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>epi-preproc[1..N] = fmriprep pre-processed files</p>
</dd>
</dl>
</dd>
<dt>blur-mult<span class="classifier">int</span></dt><dd><p>blur kernel multiplier (default = 1.5)
e.g. vox=2, blur_mult=1.5, blur size is 3 (will round float up to nearest int)</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated with names of blurred data,
epi-blur? = blurred/smoothed EPI data of run-?</p>
</dd>
</dl>
<p>Determining blur multiplier based off voxel’s dimension K.</p>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.process.reface">
<code class="sig-prename descclassname">resources.afni.process.</code><code class="sig-name descname">reface</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">subj</span></em>, <em class="sig-param"><span class="n">sess</span></em>, <em class="sig-param"><span class="n">t1_file</span></em>, <em class="sig-param"><span class="n">proj_dir</span></em>, <em class="sig-param"><span class="n">method</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.process.reface" title="Permalink to this definition">¶</a></dt>
<dd><p>De/Reface T1-weighted files.</p>
<p>Use AFNI’s refacer to deface or reface T1-weighted
structural files.</p>
<dl class="simple">
<dt>subj<span class="classifier">str</span></dt><dd><p>BIDS subject string (sub-1234)</p>
</dd>
<dt>sess<span class="classifier">str</span></dt><dd><p>BIDS session string (ses-A)</p>
</dd>
<dt>t1_file<span class="classifier">str</span></dt><dd><p>file name of T1-weighted file
(sub-1234_ses-A_T1w.nii.gz)</p>
</dd>
<dt>proj_dir<span class="classifier">str</span></dt><dd><p>path to BIDS project dir
(/path/to/BIDS/proj)</p>
</dd>
<dt>method<span class="classifier">str</span></dt><dd><p>“deface”, “reface”, or “reface_plus” method</p>
</dd>
</dl>
<dl class="simple">
<dt>return_str<span class="classifier">str</span></dt><dd><p>Success message</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.process.resting_metrics">
<code class="sig-prename descclassname">resources.afni.process.</code><code class="sig-name descname">resting_metrics</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">work_dir</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.process.resting_metrics" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate info about resting data.</p>
<p>Produce TSNR, GCOR, and noise estimations.</p>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>epi-scale1 = first/only scaled RS epi file
reg-matrix = project regression matrix
mot-censor = binary censor vector
mask-int = epi-anat intersection mask</p>
</dd>
</dl>
</dd>
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/project_dir/derivatives/afni/sub-1234/ses-A</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>not currently adding any keys/values</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.process.resting_seed">
<code class="sig-prename descclassname">resources.afni.process.</code><code class="sig-name descname">resting_seed</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">coord_dict</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">work_dir</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.process.resting_seed" title="Permalink to this definition">¶</a></dt>
<dd><p>Produce correlation matrices for seeds.</p>
<p>For each seed in coord_dict, produce a projected
correlation matrix.</p>
<dl class="simple">
<dt>coord_dict<span class="classifier">dict</span></dt><dd><p>seed name, coordinates
{“rPCC”: “5 -55 25”}</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>reg-matrix = project regression matrix
mask-int = epi-anat intersection mask
mot-censor = binary censory vector</p>
</dd>
</dl>
</dd>
<dt>work_dir<span class="classifier">str</span></dt><dd><p>location of subject’s scratch directory</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_data<span class="classifier">dict</span></dt><dd><p>updated with the fields
S&lt;seed&gt;-ztrans = Z-transformed correlation matrix of seed</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.process.scale_epi">
<code class="sig-prename descclassname">resources.afni.process.</code><code class="sig-name descname">scale_epi</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">work_dir</span></em>, <em class="sig-param"><span class="n">subj_num</span></em>, <em class="sig-param"><span class="n">afni_data</span></em>, <em class="sig-param"><span class="n">do_blur</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.process.scale_epi" title="Permalink to this definition">¶</a></dt>
<dd><p>Scale EPI runs.</p>
<p>Scale timeseries to center = 100 using AFNI’s 3dcalc.</p>
<dl class="simple">
<dt>work_dir<span class="classifier">str</span></dt><dd><p>/path/to/derivatives/afni/sub-1234/ses-A</p>
</dd>
<dt>subj_num<span class="classifier">int/str</span></dt><dd><p>subject identifier, for sbatch job name</p>
</dd>
<dt>afni_data<span class="classifier">dict</span></dt><dd><dl class="simple">
<dt>required keys</dt><dd><p>mask-min = mask of voxels with &gt;minimum signal</p>
</dd>
<dt>conditionally required keys</dt><dd><p>do_blur = T : epi-blur[1..N] = list of blurred EPI files
do_blur = F : epi-preproc[1..N] = list of fmriprep preprocessed files</p>
</dd>
</dl>
</dd>
<dt>do_blur<span class="classifier">bool</span></dt><dd><p>[T/F] whether to blur as part of pre-processing</p>
</dd>
</dl>
<dl class="simple">
<dt>afni_dict<span class="classifier">dict</span></dt><dd><p>epi-scale? = scaled EPI for run-?</p>
</dd>
</dl>
</dd></dl>

</div>
</div>
<div class="section" id="module-resources.afni.submit">
<span id="resources-afni-submit-module"></span><h2>resources.afni.submit module<a class="headerlink" href="#module-resources.afni.submit" title="Permalink to this headline">¶</a></h2>
<p>Functions to submit Bash commands as subprocesses.</p>
<p>Submit bash commands as a subprocess, either on the same
node (submit_hpc_subprocess) or on a scheduled node
(submit_hpc_sbatch). Used for wrapping AFNI and c3d
commands.</p>
<dl class="py function">
<dt id="resources.afni.submit.submit_hpc_sbatch">
<code class="sig-prename descclassname">resources.afni.submit.</code><code class="sig-name descname">submit_hpc_sbatch</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">command</span></em>, <em class="sig-param"><span class="n">wall_hours</span></em>, <em class="sig-param"><span class="n">mem_gig</span></em>, <em class="sig-param"><span class="n">num_proc</span></em>, <em class="sig-param"><span class="n">job_name</span></em>, <em class="sig-param"><span class="n">out_dir</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.submit.submit_hpc_sbatch" title="Permalink to this definition">¶</a></dt>
<dd><p>Submit job to slurm scheduler (sbatch).</p>
<p>Sbatch submit a larger job with scheduled resources. Waits for
job_name to no longer be found in squeue. Stderr/out written to
out_dir/sbatch_&lt;job_name&gt;.err/out. Supports AFNI and c3d commands.</p>
<dl class="simple">
<dt>command<span class="classifier">str</span></dt><dd><p>Bash code to be scheduled</p>
</dd>
<dt>wall_hours<span class="classifier">int</span></dt><dd><p>number of desired walltime hours</p>
</dd>
<dt>mem_gig<span class="classifier">int</span></dt><dd><p>amount of desired RAM</p>
</dd>
<dt>num_proc<span class="classifier">int</span></dt><dd><p>number of desired processors</p>
</dd>
<dt>job_name<span class="classifier">str</span></dt><dd><p>job name</p>
</dd>
<dt>out_dir<span class="classifier">str</span></dt><dd><p>location for &lt;job_name&gt;.err/out</p>
</dd>
</dl>
<dl class="simple">
<dt>(job_name, job_id)<span class="classifier">tuple of str</span></dt><dd><p>job_name = scheduled job name
job_id = scheduled job ID</p>
</dd>
</dl>
<p>submit_hpc_sbatch(“afni -ver”)</p>
</dd></dl>

<dl class="py function">
<dt id="resources.afni.submit.submit_hpc_subprocess">
<code class="sig-prename descclassname">resources.afni.submit.</code><code class="sig-name descname">submit_hpc_subprocess</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">bash_command</span></em><span class="sig-paren">)</span><a class="headerlink" href="#resources.afni.submit.submit_hpc_subprocess" title="Permalink to this definition">¶</a></dt>
<dd><p>Submit quick job as subprocess.</p>
<p>Run a quick job as a subprocess and capture stdout/err. Use
for AFNI and c3d commands.</p>
<dl class="simple">
<dt>bash_command<span class="classifier">str</span></dt><dd><p>Bash syntax, to be executed</p>
</dd>
</dl>
<dl class="simple">
<dt>(job_out, job_err)<span class="classifier">tuple of str</span></dt><dd><p>job_out = subprocess stdout
job_out = subprocess stderr</p>
</dd>
</dl>
<p>submit_hpc_subprocess(“afni -ver”)</p>
</dd></dl>

</div>
<div class="section" id="module-resources.afni">
<span id="module-contents"></span><h2>Module contents<a class="headerlink" href="#module-resources.afni" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">func_processing</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="modules.html">func_processing</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="resources.html">resources package</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflow.html">workflow package</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="modules.html">func_processing</a><ul>
  <li><a href="resources.html">resources package</a><ul>
      <li>Previous: <a href="resources.html" title="previous chapter">resources package</a></li>
      <li>Next: <a href="resources.ashs.html" title="next chapter">resources.ashs package</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Nathan Muncy.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/resources.afni.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>